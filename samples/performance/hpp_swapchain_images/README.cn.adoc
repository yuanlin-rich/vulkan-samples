////
- Copyright (c) 2022-2025, The Khronos Group
-
- SPDX-License-Identifier: Apache-2.0
-
- Licensed under the Apache License, Version 2.0 the "License";
- you may not use this file except in compliance with the License.
- You may obtain a copy of the License at
-
-     http://www.apache.org/licenses/LICENSE-2.0
-
- Unless required by applicable law or agreed to in writing, software
- distributed under the License is distributed on an "AS IS" BASIS,
- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- See the License for the specific language governing permissions and
- limitations under the License.
-
////
:doctype: book
:pp: {plus}{plus}

= 选择合适的交换链图像数量（Vulkan-Hpp 版）

ifdef::site-gen-antora[]
TIP: 本示例源码位于 https://github.com/KhronosGroup/Vulkan-Samples/tree/main/samples/performance/hpp_swapchain_images[Khronos Vulkan Samples GitHub 仓库]。
endif::[]

NOTE: 本示例是性能示例 https://github.com/KhronosGroup/Vulkan-Samples/tree/main/samples/performance/swapchain_images[Swapchain Images] 的 vulkan.hpp 绑定转译版本。

== 概览

Vulkan 允许应用对交换链图像数量进行控制。本示例分析可选配置及其性能影响。

== 选择图像数量

应用通过在 `vk::Device::createSwapchainKHR` 的 `minImageCount` 指定最小数量；实际创建数量可通过 `vk::Device::getSwapchainImagesKHR` 查询。设置前应调用 `vk::PhysicalDevice::getSurfaceCapabilitiesKHR` 获取 `vk::SurfaceCapabilitiesKHR`，其中 `minImageCount/maxImageCount` 给出可安全请求的范围。经验上移动端 `minImageCount` 通常为 2，`maxImageCount` 足够大但仍应检查。

常见请求：
- 2（双缓冲）
- 3（三缓冲）

交换链创建的图像数量同时受 `minImageCount` 与呈现模式影响。

== 选择呈现模式

可通过 `vk::PhysicalDevice::getSurfacePresentModesKHR` 查询。移动端满足 Android VSync 的模式通常只有 `vk::PresentModeKHR::eFifo` 与 `vk::PresentModeKHR::eMailbox`：
- eFifo：呈现请求排队，队列满时获取图像会等待；帧率锁 60FPS；
- eMailbox：只保留一个呈现请求，新请求会替换旧图像；

经验：请求 eMailbox 时实际图像数常 > minImageCount（典型 4），应用可持续提交新帧，适合追求低延迟，但会让 CPU/GPU 更忙，不利于移动端功耗。若无特殊需要，建议选 eFifo 以降低负载。eFifo 下创建的图像数通常等于 `minImageCount`。

== 双缓冲还是三缓冲？

Android VSync 60FPS（~16ms）。双缓冲在帧时≤16ms 时工作良好；若帧时>16ms，将出现“系统空转”并把帧率限制在 30FPS（即便应用本可达 ~50FPS）。三缓冲可避免该限制：始终有一张已处理图像可用于呈现，GPU 无需等待即可开始下一帧。

== 示例

本示例可切换双/三缓冲。实测（Mali G72）：
- 三缓冲：Sponza 稳定 60FPS；
- 双缓冲：跌至 30FPS；

当实际 CPU/GPU 帧时接近 16ms 时，从三切到双后可能短暂维持 60FPS，但一旦热/背景负载导致轻微超时，就会错过 VSync 并突降帧率。

== 最佳实践

- 建议：
  - 确保 `minImageCount` 取值位于 `getSurfaceCapabilitiesKHR` 返回的合法范围；
  - 使用 `eFifo` 避免不必要的 CPU/GPU 负载；
  - 使用三缓冲以最大化性能；
- 避免：
  - 非必要使用 `eMailbox`（除非明确追求更低输入延迟）；
  - 默认使用双缓冲（如需 30FPS 省电，可在 CPU 侧限帧，仍保留三缓冲）；
- 影响：
  - 双缓冲在错过 VSync 时会卡在下一次 VSync，限制帧率；
- 调试：
  - 通过 `vk::Device::getSwapchainImagesKHR` 检查已创建图像数；若仅 2 张且允许，增大 `minImageCount` 至 3。

////
- Copyright (c) 2023-2024, Sascha Willems
-
- SPDX-License-Identifier: Apache-2.0
-
- Licensed under the Apache License, Version 2.0 the "License";
- you may not use this file except in compliance with the License.
- You may obtain a copy of the License at
-
-     http://www.apache.org/licenses/LICENSE-2.0
-
- Unless required by applicable law or agreed to in writing, software
- distributed under the License is distributed on an "AS IS" BASIS,
- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- See the License for the specific language governing permissions and
- limitations under the License.
-
////
= 光线追踪顶点位置获取（Ray tracing position fetch）

ifdef::site-gen-antora[]
TIP: 本示例源码位于 https://github.com/KhronosGroup/Vulkan-Samples/tree/main/samples/extensions/ray_tracing_position_fetch[Khronos Vulkan Samples GitHub 仓库]。
endif::[]

== 背景

在光线追踪着色阶段访问逐顶点属性是常见需求，但通常需要通过缓冲传递并在着色器内手动索引/解包——即便这些数据（如顶点位置）已蕴含在加速结构中。

借助 `VK_KHR_ray_tracing_position_fetch`，可直接在着色器中从加速结构读取命中的三角形顶点位置。

image::./images/sample.png[Ray tracing position fetch sample]
_模型 “PICA PICA - Robot 01” by SEED.EA，来源：https://sketchfab.com/3d-models/pica-pica-robot-01-438e3a1589a6411a8e704471930389e1_

== 在应用侧

启用顶点位置获取的步骤：
- 启用设备扩展 `VK_KHR_ray_tracing_position_fetch`；
- 在 `VkPhysicalDeviceRayTracingPositionFetchFeaturesKHR` 中启用 `rayTracingPositionFetch` 特性；
- 构建 BLAS 时在 `VkBuildAccelerationStructureFlagsKHR` 中添加 `VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_DATA_ACCESS_KHR`，以允许着色器访问顶点位置；

== 在着色器侧

扩展 `SPV_KHR_ray_tracing_position_fetch` 为 Any-Hit / Closest-Hit 着色器增加了访问顶点位置的内建：

=== GLSL

[,glsl]
----
#extension GL_EXT_ray_tracing_position_fetch : require
// 命中三角形的三个顶点位置
vec3 pos0 = gl_HitTriangleVertexPositionsEXT[0];
vec3 pos1 = gl_HitTriangleVertexPositionsEXT[1];
vec3 pos2 = gl_HitTriangleVertexPositionsEXT[2];
----

=== HLSL

[,hlsl]
----
// 通过 SPIR-V 内建声明位置数组
#define HitTriangleVertexPositionsKHR 5335
#define RayTracingPositionFetchKHR 5336
[[vk::ext_extension("SPV_KHR_ray_tracing_position_fetch")]]
[[vk::ext_capability(RayTracingPositionFetchKHR)]]
[[vk::ext_builtin_input(HitTriangleVertexPositionsKHR)]]
const static float3 gl_HitTriangleVertexPositions[3];

float3 pos0 = gl_HitTriangleVertexPositions[0];
float3 pos1 = gl_HitTriangleVertexPositions[1];
float3 pos2 = gl_HitTriangleVertexPositions[2];
----

== 参考

- https://www.khronos.org/blog/introducing-vulkan-ray-tracing-position-fetch-extension